name: Sync Fork with Upstream

on:
  schedule:
    # Run daily at 2:00 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual triggering

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Add upstream remote
        run: |
          git remote add upstream https://git.netfilter.org/iptables || git remote set-url upstream https://git.netfilter.org/iptables
      
      - name: Fetch upstream changes
        run: |
          git fetch upstream
      
      - name: Get default branch from upstream
        id: default_branch
        run: |
          # Try to determine the default branch (usually 'master' or 'main')
          DEFAULT_BRANCH=$(git remote show upstream | grep 'HEAD branch' | cut -d' ' -f5)
          if [ -z "$DEFAULT_BRANCH" ]; then
            DEFAULT_BRANCH="master"
          fi
          echo "branch=$DEFAULT_BRANCH" >> $GITHUB_OUTPUT
          echo "Default branch: $DEFAULT_BRANCH"
      
      - name: Sync branches
        run: |
          DEFAULT_BRANCH="${{ steps.default_branch.outputs.branch }}"
          
          # Create or update the default branch
          if git show-ref --verify --quiet refs/heads/$DEFAULT_BRANCH; then
            git checkout $DEFAULT_BRANCH
            if ! git merge upstream/$DEFAULT_BRANCH --ff-only; then
              echo "‚ö†Ô∏è Fast-forward merge failed, performing force reset to upstream/$DEFAULT_BRANCH"
              git reset --hard upstream/$DEFAULT_BRANCH
            fi
          else
            git checkout -b $DEFAULT_BRANCH upstream/$DEFAULT_BRANCH
          fi
          
          # Push the default branch
          echo "üì§ Pushing $DEFAULT_BRANCH to origin (force push)"
          git push origin $DEFAULT_BRANCH --force
          
          # Sync all tags
          git fetch upstream --tags
          echo "üì§ Pushing tags to origin (force push)"
          git push origin --tags --force
          
          # Optionally sync other branches (uncomment if needed)
          # for branch in $(git branch -r | grep 'upstream/' | grep -v 'HEAD' | sed 's/upstream\///'); do
          #   git checkout -B $branch upstream/$branch
          #   git push origin $branch --force
          # done
      
      - name: Summary
        run: |
          echo "‚úÖ Fork synced successfully with upstream repository"
          echo "üìç Upstream: https://git.netfilter.org/iptables"
          echo "üïê Sync time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
